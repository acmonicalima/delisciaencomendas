<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DeLis Cia Encomendas</title>

<!-- Parse SDK (Back4App) -->
<script src="https://unpkg.com/parse/dist/parse.min.js"></script>

<style>
  :root{
    --primary:#623CEA;
    --secondary:#B81365;
    --light:#fafafa;
    --dark:#1a1a1a;
    --card-bg:#fff;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:var(--light); color:var(--dark) }
  .app{ display:flex; min-height:100vh; flex-direction:column }
  @media (min-width:801px){
    .app{ flex-direction:row }
  }

  /* Mobile header */
  .mobile-header{
    display:none;
    position:fixed; top:0; left:0; right:0;
    height:56px; background:var(--primary); color:white;
    display:flex; justify-content:space-between; align-items:center;
    padding:0 1rem; z-index:999;
  }
  .mobile-header h1{
    font-size:1.1rem; font-weight:700; margin:0;
  }
  .mobile-header button{
    background:transparent; border:none; color:white; font-size:1.5rem; cursor:pointer;
  }
  @media (max-width:800px){
    .mobile-header{ display:flex }
  }

  /* Sidebar / Drawer */
  .sidebar{
    width:220px; background:var(--primary); color:#fff; padding:1rem;
    display:flex; flex-direction:column;
    position:fixed; inset:0 0 0 auto; z-index:1001; transform:translateX(100%);
    transition:transform 0.3s ease;
  }
  .sidebar.open{ transform:translateX(0) }
  @media (min-width:801px){
    .sidebar{
      position:static; transform:none; display:flex; flex-direction:column;
    }
  }

  /* Overlay para drawer */
  .sidebar-overlay{
    position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:1000;
    display:none;
  }
  .sidebar-overlay.open{
    display:block;
  }

  .brand{ font-weight:700; margin-bottom:1rem; font-size:1.2rem }
  nav button{
    background:transparent; border:none; color:white; text-align:left;
    padding:0.75rem 0; cursor:pointer; width:100%; border-radius:6px;
    font-size:1rem;
  }
  nav button.active{ background:rgba(255,255,255,0.12) }

  .content{
    flex:1; padding:1rem;
    margin-top:56px; /* altura do mobile header */
  }
  @media (min-width:801px){
    .content{ margin-top:0; }
  }

  header.top{
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:1rem;
    flex-wrap:wrap;
    gap:0.5rem;
  }
  header.top h2{
    font-size:1.5rem;
    margin:0;
  }
  .btn-wrapper{ display:flex; gap:0.5rem; flex-wrap:wrap }

  .card{
    background:var(--card-bg); padding:1rem; border-radius:10px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    margin-bottom:1rem;
  }
  .grid{
    display:grid; gap:1rem;
    grid-template-columns: 1fr;
  }
  @media (min-width:600px){
    .grid{ grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
  }
  @media (min-width:801px){
    .grid{ grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
  }

  .btn{
    background:var(--primary); color:white; border:none;
    padding:0.75rem 1rem; border-radius:8px;
    cursor:pointer; font-weight:600;
    min-height:48px;
    font-size:0.95rem;
    flex:1 1 auto;
  }
  .btn.secondary{ background:var(--secondary) }
  .btn-group{ display:flex; gap:0.4rem; flex-wrap:wrap }

  label{
    display:block; margin-top:0.8rem; font-weight:600; font-size:0.95rem;
  }
  input,select,textarea{
    width:100%; padding:0.6rem; border-radius:6px;
    border:1px solid #ddd; margin-top:0.3rem;
    font-size:1rem;
  }
  textarea{ min-height:80px; resize:vertical }

  .muted{ color:#666; font-size:0.9rem }
  .list-item{
    border-left:4px solid var(--primary); padding:0.8rem;
    margin-bottom:0.6rem; border-radius:6px; background:#fff;
    font-size:0.95rem;
  }

  .modal{
    position:fixed; inset:0; background:rgba(0,0,0,0.45);
    display:flex; align-items:center; justify-content:center;
    z-index:1000; padding:1rem;
  }
  .modal-card{
    width:100%; max-width:720px; background:#fff; padding:1rem;
    border-radius:10px; max-height:90vh; overflow:auto;
    font-size:0.95rem;
  }
  @media (max-width:500px){
    .modal-card{ padding:0.75rem; }
  }

  .close-x{
    background:#eee; border-radius:6px; padding:0.2rem 0.5rem;
    cursor:pointer; font-size:1.1rem;
  }

  .toast{
    position:fixed; right:1rem; bottom:1rem;
    background:#333;color:#fff;padding:0.7rem 1rem;
    border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.2);
    z-index:2000;
    font-size:0.95rem;
  }

  .hint{ font-size:0.85rem; color:#666; margin-top:0.3rem }

  /* Encomendas list */
  .encomenda-card{
    display:flex; flex-direction:column; gap:0.5rem;
  }
  @media (min-width:600px){
    .encomenda-card{
      flex-direction:row; align-items:flex-start;
    }
  }
  .encomenda-main{ flex:1; }
  .encomenda-actions{
    display:flex; flex-wrap:wrap; gap:0.3rem;
    min-width:200px;
  }

  /* FAB para mobile */
  .fab{
    position:fixed; bottom:1.5rem; right:1.5rem;
    width:56px; height:56px; border-radius:28px;
    background:var(--primary); color:white; border:none;
    box-shadow:0 4px 12px rgba(98,60,234,0.4);
    font-size:1.5rem; display:flex; align-items:center;
    justify-content:center; z-index:900;
    display:none;
  }
  @media (max-width:800px){
    .fab{ display:flex }
  }
</style>
</head>
<body>
<!-- Mobile header -->
<header class="mobile-header" id="mobileHeader">
  <button id="btnToggleSidebar">‚ò∞</button>
  <h1 id="mobileTitle">Dashboard</h1>
  <div></div>
</header>

<!-- Sidebar overlay -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Sidebar drawer -->
<aside class="sidebar" id="sidebar">
  <div class="brand">üßÅ DeLis Cia Encomendas</div>
  <nav aria-label="Main">
    <button data-hash="#dashboard" class="nav-btn active">Dashboard</button>
    <button data-hash="#produtos" class="nav-btn">Produtos</button>
    <button data-hash="#encomendas" class="nav-btn">Encomendas</button>
    <button data-hash="#clientes" class="nav-btn">Clientes</button>
  </nav>

  <div style="margin-top:auto; font-size:0.85rem" class="muted">
    <div id="modoLabel">Modo: <strong>Offline</strong></div>
    <div style="margin-top:0.6rem">Cole suas chaves do Back4App no topo do script</div>
  </div>
</aside>

<main class="content" id="content">
  <header class="top">
    <h2 id="pageTitle">Dashboard</h2>
    <div class="btn-wrapper">
      <button id="btnNovo" class="btn">+ Novo</button>
    </div>
  </header>

  <!-- Dashboard -->
  <section id="view-dashboard" class="view">
    <div class="grid">
      <div class="card">
        <div class="muted">Faturamento (Entregues)</div>
        <div id="kpi-faturamento" style="font-size:1.4rem; font-weight:700">R$ 0,00</div>
      </div>
      <div class="card">
        <div class="muted">Encomendas Ativas</div>
        <div id="kpi-encomendas" style="font-weight:700">0</div>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem">
        <h3>√öltimas Encomendas</h3>
        <div class="muted small" id="dashboard-date"></div>
      </div>
      <div id="dashboard-latest"></div>
    </div>
  </section>

  <!-- Produtos -->
  <section id="view-produtos" class="view" style="display:none">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem">
        <h3>Produtos</h3>
        <div><button class="btn" id="btnNovoProduto">+ Produto</button></div>
      </div>
      <div id="produtos-list" style="margin-top:1rem"></div>
    </div>
  </section>

  <!-- Encomendas -->
  <section id="view-encomendas" class="view" style="display:none">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem">
        <h3>Encomendas</h3>
        <div><button class="btn" id="btnNovaEncomenda">+ Nova Encomenda</button></div>
      </div>
      <div id="encomendas-list" style="margin-top:1rem"></div>
    </div>
  </section>

  <!-- Clientes -->
  <section id="view-clientes" class="view" style="display:none">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem">
        <h3>Clientes</h3>
        <div><button class="btn" id="btnNovoCliente">+ Cliente</button></div>
      </div>
      <div id="clientes-list" style="margin-top:1rem"></div>
    </div>
  </section>
</main>

<!-- Bot√£o flutuante -->
<button class="fab" id="fabNovo">+</button>

<div id="modalRoot" style="display:none"></div>
<div id="toast" style="display:none" class="toast"></div>

<script>
/*
  ‚úÖ DeLis Cia Encomendas ‚Äî Vers√£o Responsiva Completa
  ‚úÖ Funciona em celular, tablet e desktop
  ‚úÖ Back4App + localStorage fallback
*/

/* =================== CONFIGURA√á√ÉO BACK4APP =================== */
const PARSE_APP_ID = "G7NhtaEthUcVrUv296Ks7uXEg5kd0WDrpS41qoZ6";
const PARSE_JS_KEY = "k6CDycVRCrx74efgZeqNekI1RSp664SWyqu9PegP";
const PARSE_SERVER_URL = "https://parseapi.back4app.com/";

let USING_PARSE = false;
if (PARSE_APP_ID && PARSE_JS_KEY) {
  try {
    Parse.initialize(PARSE_APP_ID, PARSE_JS_KEY);
    Parse.serverURL = PARSE_SERVER_URL;
    USING_PARSE = true;
    document.getElementById('modoLabel').innerHTML = 'Modo: <strong>Back4App</strong>';
  } catch (e) {
    console.warn('Erro inicializando Parse:', e);
    document.getElementById('modoLabel').innerHTML = 'Modo: <strong>Offline</strong>';
    USING_PARSE = false;
  }
} else {
  document.getElementById('modoLabel').innerHTML = 'Modo: <strong>Offline</strong>';
}

/* =================== STORE SIMPLES =================== */
const store = { clientes: [], produtos: [], encomendas: [] };
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9) }
function money(v){ return v==null ? 'R$ 0,00' : new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v) }
function showToast(msg, t=2200){ const el=document.getElementById('toast'); el.textContent=msg; el.style.display='block'; clearTimeout(el._to); el._to=setTimeout(()=>el.style.display='none',t); }

/* =================== PERSIST√äNCIA COMPLETA =================== */

/* Clientes */
async function fetchClientes(){
  if (USING_PARSE){
    const C = Parse.Object.extend('Cliente');
    const q = new Parse.Query(C); q.ascending('nome');
    const res = await q.find();
    store.clientes = res.map(r=>({ id:r.id, nome:r.get('nome'), telefone:r.get('telefone')||'' }));
  } else {
    store.clientes = JSON.parse(localStorage.getItem('clientes')||'[]');
  }
  return store.clientes;
}
async function saveCliente(c){
  if (USING_PARSE){
    const C = Parse.Object.extend('Cliente');
    if (c.id){
      const q = new Parse.Query(C); const obj = await q.get(c.id);
      obj.set('nome', c.nome); obj.set('telefone', c.telefone||''); await obj.save();
    } else {
      const obj = new C(); obj.set('nome', c.nome); obj.set('telefone', c.telefone||''); const s = await obj.save(); c.id = s.id;
    }
    await fetchClientes();
  } else {
    if (!c.id) c.id = uid('cli');
    const idx = (store.clientes||[]).findIndex(x=>x.id===c.id);
    if (idx>=0) store.clientes[idx] = c; else store.clientes.push(c);
    localStorage.setItem('clientes', JSON.stringify(store.clientes));
  }
  showToast('Cliente salvo ‚úÖ');
}
async function deleteCliente(id){
  if (USING_PARSE){
    const C = Parse.Object.extend('Cliente'); const q=new Parse.Query(C); const obj=await q.get(id); await obj.destroy(); await fetchClientes();
  } else {
    store.clientes = store.clientes.filter(c=>c.id!==id); localStorage.setItem('clientes', JSON.stringify(store.clientes));
  }
  showToast('Cliente removido');
}

/* Produtos */
async function fetchProdutos(){
  if (USING_PARSE){
    const P = Parse.Object.extend('Produto'); const q=new Parse.Query(P); q.ascending('nome');
    const res = await q.find();
    store.produtos = res.map(r=>({ id:r.id, nome:r.get('nome'), descricao:r.get('descricao')||'', preco: r.get('preco')||0 }));
  } else {
    store.produtos = JSON.parse(localStorage.getItem('produtos')||'[]');
  }
  return store.produtos;
}
async function saveProduto(p){
  if (USING_PARSE){
    const P = Parse.Object.extend('Produto');
    if (p.id){
      const q=new Parse.Query(P); const obj=await q.get(p.id);
      obj.set('nome', p.nome); obj.set('descricao', p.descricao||''); obj.set('preco', p.preco||0); await obj.save();
    } else {
      const obj = new P(); obj.set('nome', p.nome); obj.set('descricao', p.descricao||''); obj.set('preco', p.preco||0); const s = await obj.save(); p.id = s.id;
    }
    await fetchProdutos();
  } else {
    if (!p.id) p.id = uid('prd');
    const idx = (store.produtos||[]).findIndex(x=>x.id===p.id);
    if (idx>=0) store.produtos[idx] = p; else store.produtos.push(p);
    localStorage.setItem('produtos', JSON.stringify(store.produtos));
  }
  showToast('Produto salvo ‚úÖ');
}
async function deleteProduto(id){
  if (USING_PARSE){
    const P = Parse.Object.extend('Produto'); const q=new Parse.Query(P); const obj=await q.get(id); await obj.destroy(); await fetchProdutos();
  } else {
    store.produtos = store.produtos.filter(p=>p.id!==id); localStorage.setItem('produtos', JSON.stringify(store.produtos));
  }
  showToast('Produto removido');
}

/* Encomendas */
async function fetchEncomendas(){
  if (USING_PARSE){
    const En = Parse.Object.extend('Encomenda'); const q=new Parse.Query(En); q.descending('createdAt'); q.include('cliente'); q.include('produto');
    const res = await q.find();
    store.encomendas = res.map(r=>({
      id: r.id,
      clienteId: r.get('cliente') ? r.get('cliente').id : null,
      clienteNome: r.get('cliente') ? r.get('cliente').get('nome') : r.get('clienteNome') || '',
      produtoId: r.get('produto') ? r.get('produto').id : null,
      produtoNome: r.get('produto') ? r.get('produto').get('nome') : r.get('produtoNome') || '',
      quantidade: r.get('quantidade') || 1,
      valor: r.get('valor') || 0,
      dataEntrega: r.get('dataEntrega') || '',
      statusProducao: r.get('statusProducao') || 'A Fazer',
      statusPagamento: r.get('statusPagamento') || 'Pendente',
      logs: r.get('logs') || []
    }));
  } else {
    store.encomendas = JSON.parse(localStorage.getItem('encomendas')||'[]');
  }
  return store.encomendas;
}
async function saveEncomenda(en){
  if (USING_PARSE){
    const En = Parse.Object.extend('Encomenda');
    if (en.id){
      const q = new Parse.Query(En); const obj = await q.get(en.id);
      if (en.clienteId) obj.set('cliente', { __type:'Pointer', className:'Cliente', objectId: en.clienteId }); else obj.set('clienteNome', en.clienteNome);
      if (en.produtoId) obj.set('produto', { __type:'Pointer', className:'Produto', objectId: en.produtoId }); else obj.set('produtoNome', en.produtoNome);
      obj.set('quantidade', en.quantidade || 1); obj.set('valor', en.valor || 0);
      obj.set('dataEntrega', en.dataEntrega || '');
      obj.set('statusProducao', en.statusProducao || 'A Fazer'); obj.set('statusPagamento', en.statusPagamento || 'Pendente'); obj.set('logs', en.logs || []);
      await obj.save();
    } else {
      const obj = new En();
      if (en.clienteId) obj.set('cliente', { __type:'Pointer', className:'Cliente', objectId: en.clienteId }); else obj.set('clienteNome', en.clienteNome);
      if (en.produtoId) obj.set('produto', { __type:'Pointer', className:'Produto', objectId: en.produtoId }); else obj.set('produtoNome', en.produtoNome);
      obj.set('quantidade', en.quantidade || 1); obj.set('valor', en.valor || 0);
      obj.set('dataEntrega', en.dataEntrega || '');
      obj.set('statusProducao', en.statusProducao || 'A Fazer'); obj.set('statusPagamento', en.statusPagamento || 'Pendente'); obj.set('logs', en.logs || []);
      const s = await obj.save(); en.id = s.id;
    }
    await fetchEncomendas();
  } else {
    if (!en.id) en.id = uid('enc');
    const idx = (store.encomendas||[]).findIndex(x=>x.id===en.id);
    if (idx>=0) store.encomendas[idx] = en; else store.encomendas.unshift(en);
    localStorage.setItem('encomendas', JSON.stringify(store.encomendas));
  }
  showToast('Encomenda salva ‚úÖ');
}
async function deleteEncomenda(id){
  if (USING_PARSE){
    const En = Parse.Object.extend('Encomenda'); const q=new Parse.Query(En); const obj = await q.get(id); await obj.destroy(); await fetchEncomendas();
  } else {
    store.encomendas = store.encomendas.filter(e=>e.id!==id); localStorage.setItem('encomendas', JSON.stringify(store.encomendas));
  }
  showToast('Encomenda cancelada');
}

/* =================== UTILS =================== */
function preparePhoneForSave(raw){
  if (!raw) return null;
  let s = String(raw).trim();
  s = s.replace(/[^\d+]/g, '');
  if (s.startsWith('+')) s = s.slice(1);
  s = s.replace(/^0+/, '');
  if (s.startsWith('55')) s = s.slice(2);
  if (s.length === 11 || s.length === 10){
    return '+55' + s;
  }
  return null;
}

function calcularValorEncomenda(produtoId, quantidade){
  const p = store.produtos.find(x=>x.id===produtoId) || { preco:0 };
  return (parseFloat(p.preco)||0) * (parseFloat(quantidade)||0);
}

function montarMensagemWhatsApp(en){
  const nome = en.clienteNome || '';
  const produto = en.produtoNome || '';
  const data = en.dataEntrega || '';
  let displayDate = data;
  if (/^\d{4}-\d{2}-\d{2}$/.test(data)){
    const parts = data.split('-');
    displayDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
  }
  return `Ol√°, ${nome}! Sua encomenda do produto ${produto} est√° prevista para ${displayDate}.`;
}

function pushLog(en, text){
  en.logs = en.logs || [];
  en.logs.push(`${new Date().toLocaleString('pt-BR')} - ${text}`);
}

/* =================== RENDERIZA√á√ÉO =================== */
async function renderAll(){
  await fetchClientes(); await fetchProdutos(); await fetchEncomendas();
  document.getElementById('kpi-faturamento').textContent = money(store.encomendas.filter(e=>e.statusProducao==='Entregue').reduce((s,e)=>s+ (e.valor||0),0));
  document.getElementById('kpi-encomendas').textContent = store.encomendas.filter(e=>e.statusProducao!=='Entregue').length;
  document.getElementById('dashboard-date').textContent = new Date().toLocaleDateString('pt-BR');
  renderClientes(); renderProdutos(); renderEncomendas(); renderDashboardLatest();
}

function renderDashboardLatest(){
  const latest = (store.encomendas||[]).slice(0,5);
  const container = document.getElementById('dashboard-latest');
  if (!latest.length) container.innerHTML = '<p class="muted">Nenhuma encomenda ainda.</p>';
  else container.innerHTML = latest.map(e=>`
    <div class="list-item">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.3rem">
        <div><strong>${e.clienteNome || 'Cliente'}</strong><div class="muted small">${e.dataEntrega}</div></div>
        <div>${money(e.valor)}</div>
      </div>
      <div class="muted small">${e.quantidade} x ${e.produtoNome} ‚Ä¢ ${e.statusProducao}</div>
    </div>
  `).join('');
}

function renderProdutos(){
  const c = document.getElementById('produtos-list');
  if (!store.produtos.length) { c.innerHTML = '<p class="muted">Nenhum produto. <button class="btn" id="addFirstProduto">Adicionar</button></p>'; setTimeout(()=>document.getElementById('addFirstProduto')?.addEventListener('click', openProdutoModal),50); return; }
  c.innerHTML = store.produtos.map(p=>`
    <div class="card" style="display:flex; flex-direction:column; gap:0.5rem">
      <div>
        <h4 style="margin:0">${p.nome}</h4>
        <div class="muted small">${p.descricao||''}</div>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.3rem">
        <div style="font-weight:700">${money(p.preco)}</div>
        <div class="btn-group">
          <button class="btn" onclick="editarProduto('${p.id}')">‚úèÔ∏è</button>
          <button class="btn secondary" onclick="removerProduto('${p.id}')">üóëÔ∏è</button>
        </div>
      </div>
    </div>
  `).join('');
}

function renderClientes(){
  const c = document.getElementById('clientes-list');
  if (!store.clientes.length) { c.innerHTML = '<p class="muted">Nenhum cliente. <button class="btn" id="addFirstCliente">Adicionar</button></p>'; setTimeout(()=>document.getElementById('addFirstCliente')?.addEventListener('click', openClienteModal),50); return; }
  c.innerHTML = store.clientes.map(cl=>`
    <div class="card" style="display:flex; flex-direction:column; gap:0.5rem">
      <div><strong>${cl.nome}</strong><div class="muted small">${cl.telefone||''}</div></div>
      <div class="btn-group">
        <button class="btn" onclick="editarCliente('${cl.id}')">‚úèÔ∏è</button>
        <button class="btn secondary" onclick="removerCliente('${cl.id}')">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
}

function renderEncomendas(){
  const c = document.getElementById('encomendas-list');
  if (!store.encomendas.length) { c.innerHTML = '<p class="muted">Nenhuma encomenda. <button class="btn" id="addFirstEncomenda">Criar</button></p>'; setTimeout(()=>document.getElementById('addFirstEncomenda')?.addEventListener('click', ()=>openEncomendaModal()),50); return; }
  c.innerHTML = store.encomendas.map(e=>`
    <div class="card encomenda-card">
      <div class="encomenda-main">
        <strong>${e.clienteNome || 'Cliente'}</strong>
        <div class="muted small">${e.dataEntrega}</div>
        <div style="margin-top:0.3rem">${e.produtoNome} ‚Ä¢ ${e.quantidade} unid.</div>
        <div class="muted small">Status: ${e.statusProducao}</div>
      </div>
      <div class="encomenda-actions">
        <button class="btn" onclick="editarEncomenda('${e.id}')">‚úèÔ∏è</button>
        <button class="btn" onclick="abrirStatusModal('${e.id}')">‚öôÔ∏è</button>
        <button class="btn secondary" onclick="compartilharWhatsApp('${e.id}')">üì≤</button>
        <button class="btn secondary" onclick="cancelarEncomenda('${e.id}')">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
}

/* =================== MODAIS & CRUD UI =================== */
const modalRoot = document.getElementById('modalRoot');
function openModal(html){ modalRoot.style.display='block'; modalRoot.innerHTML = `<div class="modal">${html}</div>`; }
function closeModal(){ modalRoot.style.display='none'; modalRoot.innerHTML=''; }

/* CLIENTE */
function openClienteModal(existing){
  const nome = existing?.nome || '';
  const tel = existing?.telefone || '';
  openModal(`
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center"><h3>${existing?'Editar Cliente':'Novo Cliente'}</h3><div class="close-x" onclick="closeModal()">‚úñ</div></div>
      <label>Nome<input id="m_cli_nome" placeholder="Ex: Maria da Silva" value="${nome}"></label>
      <label>Telefone<input id="m_cli_tel" placeholder="Ex: (21) 98765-4321 ‚Äî ser√° salvo como +5521987654321" value="${tel}"></label>
      <div class="hint">Formato salvo para WhatsApp: +55DDDN√öMERO (ser√° formatado automaticamente)</div>
      <div style="display:flex; gap:0.5rem; margin-top:1rem">
        <button class="btn" id="saveCliBtn">Salvar</button>
        <button class="btn secondary" onclick="closeModal()">Cancelar</button>
      </div>
    </div>
  `);
  document.getElementById('saveCliBtn').addEventListener('click', async ()=>{
    const nomeVal = document.getElementById('m_cli_nome').value.trim();
    const telRaw = document.getElementById('m_cli_tel').value.trim();
    if (!nomeVal) return showToast('Nome √© obrigat√≥rio');
    const telPrepared = preparePhoneForSave(telRaw);
    if (!telPrepared) return alert('Telefone inv√°lido. Inclua DDD (ex: (21) 98765-4321).');
    const c = { id: existing?.id, nome: nomeVal, telefone: telPrepared };
    await saveCliente(c); await renderAll(); closeModal();
  });
}

/* PRODUTO */
function openProdutoModal(existing){
  const nome = existing?.nome || '';
  const desc = existing?.descricao || '';
  const preco = existing?.preco || '';
  openModal(`
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center"><h3>${existing?'Editar Produto':'Novo Produto'}</h3><div class="close-x" onclick="closeModal()">‚úñ</div></div>
      <label>Nome<input id="m_prd_nome" placeholder="Ex: Brigadeiro Gourmet" value="${nome}"></label>
      <label>Pre√ßo (ex: 40 ‚Äî sem v√≠rgula; pode usar decimais com ponto: 40.50)<input id="m_prd_preco" type="text" placeholder="Ex: 40" value="${preco}"></label>
      <label>Descri√ß√£o<textarea id="m_prd_desc" placeholder="Breve descri√ß√£o">${desc}</textarea></label>
      <div style="display:flex; gap:0.5rem; margin-top:1rem">
        <button class="btn" id="savePrdBtn">Salvar</button>
        <button class="btn secondary" onclick="closeModal()">Cancelar</button>
      </div>
    </div>
  `);
  document.getElementById('savePrdBtn').addEventListener('click', async ()=>{
    const nomeVal = document.getElementById('m_prd_nome').value.trim();
    let precoRaw = document.getElementById('m_prd_preco').value.trim();
    const descVal = document.getElementById('m_prd_desc').value.trim();
    if (!nomeVal) return showToast('Nome √© obrigat√≥rio');
    precoRaw = precoRaw.replace(',', '.');
    const precoNum = parseFloat(precoRaw) || 0;
    const p = { id: existing?.id, nome: nomeVal, preco: precoNum, descricao: descVal };
    await saveProduto(p); await renderAll(); closeModal();
  });
}

/* ENCOMENDA */
function openEncomendaModal(existing){
  const clientesOptions = ['<option value="">Selecione...</option>'].concat(store.clientes.map(c=>`<option value="${c.id}">${c.nome}</option>`)).join('');
  const produtosOptions = ['<option value="">Selecione...</option>'].concat(store.produtos.map(p=>`<option value="${p.id}" data-preco="${p.preco}">${p.nome} - ${money(p.preco)}</option>`)).join('');
  const dataVal = existing?.dataEntrega ? existing.dataEntrega : new Date().toISOString().slice(0,10);
  const quantidadeVal = existing?.quantidade || 1;
  const valorVal = existing?.valor || '';
  openModal(`
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center"><h3>${existing?'Editar Encomenda':'Nova Encomenda'}</h3><div class="close-x" onclick="closeModal()">‚úñ</div></div>
      <label>Cliente<select id="m_enc_cliente">${clientesOptions}</select></label>
      <label>Produto<select id="m_enc_produto">${produtosOptions}</select></label>
      <label>Quantidade<input id="m_enc_qtd" type="number" min="1" value="${quantidadeVal}"></label>
      <label>Valor (ex: 40 ‚Äî sem v√≠rgula; use ponto para decimais: 40.50)<input id="m_enc_valor" type="text" placeholder="Ex: 40" value="${valorVal}"></label>
      <label>Data de entrega<input id="m_enc_data" type="date" value="${dataVal}"></label>
      <div style="display:flex; gap:0.5rem; margin-top:1rem">
        <button class="btn" id="saveEncBtn">Salvar</button>
        <button class="btn secondary" onclick="closeModal()">Cancelar</button>
      </div>
    </div>
  `);

  if (existing){
    document.getElementById('m_enc_cliente').value = existing.clienteId || '';
    document.getElementById('m_enc_produto').value = existing.produtoId || '';
    document.getElementById('m_enc_qtd').value = existing.quantidade || 1;
    document.getElementById('m_enc_valor').value = existing.valor || '';
  }

  document.getElementById('saveEncBtn').addEventListener('click', async ()=>{
    const clienteId = document.getElementById('m_enc_cliente').value;
    const produtoId = document.getElementById('m_enc_produto').value;
    const quantidade = parseInt(document.getElementById('m_enc_qtd').value) || 1;
    let valorRaw = document.getElementById('m_enc_valor').value.trim();
    const dataEntrega = document.getElementById('m_enc_data').value;
    if (!clienteId || !produtoId) return showToast('Selecione cliente e produto');
    valorRaw = valorRaw.replace(',', '.');
    const valor = parseFloat(valorRaw) || calcularValorEncomenda(produtoId, quantidade);
    const clienteNome = (store.clientes.find(c=>c.id===clienteId)||{}).nome || '';
    const produtoNome = (store.produtos.find(p=>p.id===produtoId)||{}).nome || '';
    const en = { 
      id: existing?.id, 
      clienteId, clienteNome, 
      produtoId, produtoNome, 
      quantidade, valor, dataEntrega, 
      statusProducao: existing?.statusProducao || 'A Fazer', 
      statusPagamento: existing?.statusPagamento || 'Pendente', 
      logs: existing?.logs||[] 
    };
    pushLog(en, existing ? 'Encomenda editada' : 'Encomenda criada');
    await saveEncomenda(en);
    await renderAll();
    closeModal();

    // WhatsApp quick modal
    setTimeout(()=> {
      const mensagem = montarMensagemWhatsApp(en);
      const cliente = store.clientes.find(c=>c.id===en.clienteId) || { telefone:'' };
      const numero = (cliente.telefone || '');
      if (!numero){
        alert('Encomenda salva, mas cliente n√£o tem telefone v√°lido para WhatsApp.');
        return;
      }
      openModal(`
        <div class="modal-card">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <h3>Encomenda salva ‚úÖ</h3>
            <div class="close-x" onclick="closeModal()">‚úñ</div>
          </div>
          <p>Mensagem pronta para enviar via WhatsApp:</p>
          <div class="card"><em>${mensagem}</em></div>
          <div style="display:flex; gap:0.6rem; margin-top:1rem">
            <button class="btn" id="openWppBtn">Abrir WhatsApp</button>
            <button class="btn secondary" onclick="closeModal()">Fechar</button>
          </div>
        </div>
      `);
      document.getElementById('openWppBtn').addEventListener('click', ()=>{
        const n = numero.replace(/\D/g,'');
        const url = `https://wa.me/${n}?text=${encodeURIComponent(mensagem)}`;
        window.open(url, '_blank');
      });
    }, 200);
  });
}

/* STATUS modal */
function abrirStatusModal(id){
  const e = store.encomendas.find(x=>x.id===id); if(!e) return;
  openModal(`
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center"><h3>Atualizar Status - ${e.clienteNome}</h3><div class="close-x" onclick="closeModal()">‚úñ</div></div>
      <label>Status Produ√ß√£o
        <select id="m_st_prod">
          <option value="A Fazer">A Fazer</option>
          <option value="Pronto para Entrega">Pronto para Entrega</option>
          <option value="Entregue">Entregue</option>
        </select>
      </label>
      <label>Status Pagamento
        <select id="m_st_pay">
          <option value="Pendente">Pendente</option>
          <option value="Sinal Pago">Sinal Pago</option>
          <option value="Pago Totalmente">Pago Totalmente</option>
        </select>
      </label>
      <div style="display:flex; gap:0.5rem; margin-top:1rem">
        <button class="btn" id="saveStatusBtn">Salvar</button>
        <button class="btn secondary" onclick="closeModal()">Cancelar</button>
      </div>
    </div>
  `);
  document.getElementById('m_st_prod').value = e.statusProducao || 'A Fazer';
  document.getElementById('m_st_pay').value = e.statusPagamento || 'Pendente';
  document.getElementById('saveStatusBtn').addEventListener('click', async ()=>{
    const novoProd = document.getElementById('m_st_prod').value;
    const novoPay = document.getElementById('m_st_pay').value;
    e.statusProducao = novoProd; e.statusPagamento = novoPay;
    pushLog(e, `Status produ√ß√£o: ${novoProd} | pagamento: ${novoPay}`);
    await saveEncomenda(e); await renderAll(); closeModal();
  });
}

/* =================== A√á√ïES GLOBAIS =================== */
function editarProduto(id){ const p = store.produtos.find(x=>x.id===id); if(!p) return; openProdutoModal(p); }
function removerProduto(id){ if(!confirm('Remover produto?')) return; deleteProduto(id).then(()=>renderAll()); }
function editarCliente(id){ const c = store.clientes.find(x=>x.id===id); if(!c) return; openClienteModal(c); }
function removerCliente(id){ if(!confirm('Remover cliente?')) return; deleteCliente(id).then(()=>renderAll()); }
function editarEncomenda(id){ const e = store.encomendas.find(x=>x.id===id); if(!e) return; openEncomendaModal(e); }
function cancelarEncomenda(id){ if(!confirm('Cancelar encomenda?')) return; deleteEncomenda(id).then(()=>renderAll()); }
function compartilharWhatsApp(id){
  const e = store.encomendas.find(x=>x.id===id); if(!e) return;
  const cliente = store.clientes.find(c=>c.id===e.clienteId) || { telefone:'' };
  const numero = (cliente.telefone||'');
  if (!numero) { alert('Telefone inv√°lido para WhatsApp'); return; }
  const mensagem = montarMensagemWhatsApp(e);
  const n = numero.replace(/\D/g,'');
  const url = `https://wa.me/${n}?text=${encodeURIComponent(mensagem)}`;
  window.open(url, '_blank');
}

/* =================== CONTROLE DE MOBILE DRAWER =================== */
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');
const btnToggle = document.getElementById('btnToggleSidebar');

function toggleSidebar(){
  sidebar.classList.toggle('open');
  sidebarOverlay.classList.toggle('open');
}

btnToggle.addEventListener('click', toggleSidebar);
sidebarOverlay.addEventListener('click', toggleSidebar);
document.querySelectorAll('.nav-btn').forEach(btn => {
  btn.addEventListener('click', ()=>{
    if (window.innerWidth <= 800) {
      toggleSidebar();
    }
    location.hash = btn.dataset.hash;
  });
});

/* =================== NAV & UI SYNC =================== */
function updateMobileTitle(hash){
  const titles = {
    '#dashboard': 'Dashboard',
    '#produtos': 'Produtos',
    '#encomendas': 'Encomendas',
    '#clientes': 'Clientes'
  };
  const title = titles[hash] || 'Dashboard';
  document.getElementById('mobileTitle').textContent = title;
  document.getElementById('pageTitle').textContent = title;
}

function showView(hash){
  document.querySelectorAll('.view').forEach(v=>v.style.display='none');
  const h = hash || '#dashboard';
  const map = { '#dashboard':'view-dashboard', '#produtos':'view-produtos', '#encomendas':'view-encomendas', '#clientes':'view-clientes' };
  const key = map[h] || 'view-dashboard';
  document.getElementById(key).style.display='block';
  document.querySelectorAll('.nav-btn').forEach(b=> b.classList.toggle('active', b.dataset.hash===h));
  
  updateMobileTitle(h);

  const btn = document.getElementById('btnNovo');
  btn.onclick = null;
  if (h==='#produtos'){ btn.textContent = '+ Produto'; btn.onclick = ()=>openProdutoModal(); }
  else if (h==='#clientes'){ btn.textContent = '+ Cliente'; btn.onclick = ()=>openClienteModal(); }
  else if (h==='#encomendas'){ btn.textContent = '+ Encomenda'; btn.onclick = ()=>openEncomendaModal(); }
  else { btn.textContent = '+ Novo'; btn.onclick = ()=>openEncomendaModal(); }

  document.getElementById('fabNovo').onclick = btn.onclick;
}

window.addEventListener('hashchange', ()=> showView(location.hash));
document.getElementById('btnNovoProduto').addEventListener('click', ()=> openProdutoModal());
document.getElementById('btnNovoCliente').addEventListener('click', ()=> openClienteModal());
document.getElementById('btnNovaEncomenda').addEventListener('click', ()=> openEncomendaModal());

/* Registra fun√ß√µes globais para onclick inline */
window.openClienteModal = openClienteModal;
window.openProdutoModal = openProdutoModal;
window.openEncomendaModal = openEncomendaModal;
window.editarProduto = editarProduto;
window.removerProduto = removerProduto;
window.editarCliente = editarCliente;
window.removerCliente = removerCliente;
window.editarEncomenda = editarEncomenda;
window.cancelarEncomenda = cancelarEncomenda;
window.abrirStatusModal = abrirStatusModal;
window.compartilharWhatsApp = compartilharWhatsApp;

/* =================== INICIALIZA√á√ÉO =================== */
(async function init(){
  await renderAll();
  showView(location.hash || '#dashboard');
})();
</script>
</body>
</html>
