<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeLis Cia Encomendas</title>

<!-- Parse SDK (Back4App) -->
<script src="https://unpkg.com/parse/dist/parse.min.js"></script>

<style>
  :root{
    --primary:#623CEA;
    --secondary:#B81365;
    --light:#fafafa;
    --dark:#1a1a1a;
    --card-bg:#fff;
  }
  *{box-sizing:border-box}
  body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:var(--light); color:var(--dark) }
  .app{ display:flex; min-height:100vh; }
  .sidebar{ width:220px; background:var(--primary); color:#fff; padding:1rem; display:flex; flex-direction:column }
  .brand{ font-weight:700; margin-bottom:1rem }
  nav button{ background:transparent; border:none; color:white; text-align:left; padding:0.5rem 0; cursor:pointer; width:100%; border-radius:6px }
  nav button.active{ background:rgba(255,255,255,0.12) }
  .content{ flex:1; padding:1rem }
  header.top{ display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem }
  .card{ background:var(--card-bg); padding:1rem; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); margin-bottom:1rem }
  .grid{ display:grid; gap:1rem; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); }
  .btn{ background:var(--primary); color:white; border:none; padding:0.6rem 0.9rem; border-radius:8px; cursor:pointer; font-weight:600 }
  .btn.secondary{ background:var(--secondary) }
  label{ display:block; margin-top:0.6rem; font-weight:600 }
  input,select,textarea{ width:100%; padding:0.5rem; border-radius:6px; border:1px solid #ddd; margin-top:0.3rem }
  .muted{ color:#666; font-size:0.9rem }
  .list-item{ border-left:4px solid var(--primary); padding:0.8rem; margin-bottom:0.6rem; border-radius:6px; background:#fff }
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:1000 }
  .modal-card{ width:95%; max-width:720px; background:#fff; padding:1rem; border-radius:10px; max-height:90vh; overflow:auto }
  .close-x{ background:#eee; border-radius:6px; padding:0.2rem 0.5rem; cursor:pointer }
  .toast{ position:fixed; right:1rem; bottom:1rem; background:#333;color:#fff;padding:0.6rem 1rem;border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.2) }
  .hint{ font-size:0.85rem; color:#666 }
  @media (max-width:800px){ .sidebar{ display:none } }
</style>
</head>
<body>
<div class="app" id="app">
  <aside class="sidebar" id="sidebar">
    <div class="brand">üßÅ DeLis Cia Encomendas</div>
    <nav aria-label="Main">
      <button data-hash="#dashboard" class="nav-btn active">Dashboard</button>
      <button data-hash="#produtos" class="nav-btn">Produtos</button>
      <button data-hash="#encomendas" class="nav-btn">Encomendas</button>
      <button data-hash="#clientes" class="nav-btn">Clientes</button>
    </nav>

    <div style="margin-top:auto; font-size:0.9rem" class="muted">
      <div id="modoLabel">Modo: <strong>Offline</strong></div>
      <div style="margin-top:0.6rem">Cole suas chaves do Back4App no topo do script</div>
    </div>
  </aside>

  <main class="content" id="content">
    <header class="top">
      <h2 id="pageTitle">Dashboard</h2>
      <div style="display:flex; gap:0.5rem; align-items:center">
        <button id="btnNovo" class="btn">+ Novo</button>
      </div>
    </header>

    <!-- Dashboard -->
    <section id="view-dashboard" class="view">
      <div class="grid">
        <div class="card">
          <div class="muted">Faturamento (Entregues)</div>
          <div id="kpi-faturamento" style="font-size:1.4rem; font-weight:700">R$ 0,00</div>
        </div>
        <div class="card">
          <div class="muted">Encomendas Ativas</div>
          <div id="kpi-encomendas" style="font-weight:700">0</div>
        </div>
      </div>

      <div class="card" style="margin-top:1rem">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <h3>√öltimas Encomendas</h3>
          <div class="muted small" id="dashboard-date"></div>
        </div>
        <div id="dashboard-latest"></div>
      </div>
    </section>

    <!-- Produtos -->
    <section id="view-produtos" class="view" style="display:none">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <h3>Produtos</h3>
          <div><button class="btn" id="btnNovoProduto">+ Produto</button></div>
        </div>
        <div id="produtos-list" style="margin-top:1rem"></div>
      </div>
    </section>

    <!-- Encomendas -->
    <section id="view-encomendas" class="view" style="display:none">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <h3>Encomendas</h3>
          <div><button class="btn" id="btnNovaEncomenda">+ Nova Encomenda</button></div>
        </div>
        <div id="encomendas-list" style="margin-top:1rem"></div>
      </div>
    </section>

    <!-- Clientes -->
    <section id="view-clientes" class="view" style="display:none">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <h3>Clientes</h3>
          <div><button class="btn" id="btnNovoCliente">+ Cliente</button></div>
        </div>
        <div id="clientes-list" style="margin-top:1rem"></div>
      </div>
    </section>
  </main>
</div>

<div id="modalRoot" style="display:none"></div>
<div id="toast" style="display:none" class="toast"></div>

<script>
/*
  index.html completo - DeLis Cia Encomendas
  - Cole suas chaves do Back4App nas CONSTANTES abaixo (no VSCode)
  - Cliente.telefone ser√° SALVO no formato internacional +55DDDN√öMERO
  - Mensagem WhatsApp aparece logo ap√≥s salvar a encomenda
*/

/* =================== CONFIGURA√á√ÉO BACK4APP =================== */
/* N√ÉO cole chaves aqui no chat. Cole no VSCode nas constantes abaixo */
const PARSE_APP_ID = "G7NhtaEthUcVrUv296Ks7uXEg5kd0WDrpS41qoZ6";   // <-- cole Application ID (Back4App)
const PARSE_JS_KEY = "k6CDycVRCrx74efgZeqNekI1RSp664SWyqu9PegP";   // <-- cole JavaScript Key (Back4App)
const PARSE_SERVER_URL = "https://parseapi.back4app.com/";

let USING_PARSE = false;
if (PARSE_APP_ID && PARSE_JS_KEY) {
  try {
    Parse.initialize(PARSE_APP_ID, PARSE_JS_KEY);
    Parse.serverURL = PARSE_SERVER_URL;
    USING_PARSE = true;
    document.getElementById('modoLabel').innerHTML = 'Modo: <strong>Back4App</strong>';
  } catch (e) {
    console.warn('Erro inicializando Parse:', e);
    document.getElementById('modoLabel').innerHTML = 'Modo: <strong>Offline</strong>';
    USING_PARSE = false;
  }
} else {
  document.getElementById('modoLabel').innerHTML = 'Modo: <strong>Offline</strong>';
}

/* =================== STORE SIMPLES =================== */
const store = { clientes: [], produtos: [], encomendas: [] };
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9) }
function money(v){ return v==null ? 'R$ 0,00' : new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v) }
function showToast(msg, t=2200){ const el=document.getElementById('toast'); el.textContent=msg; el.style.display='block'; clearTimeout(el._to); el._to=setTimeout(()=>el.style.display='none',t); }

/* =================== PERSIST√äNCIA =================== */
/* Clientes */
async function fetchClientes(){
  if (USING_PARSE){
    const C = Parse.Object.extend('Cliente');
    const q = new Parse.Query(C); q.ascending('nome');
    const res = await q.find();
    store.clientes = res.map(r=>({ id:r.id, nome:r.get('nome'), telefone:r.get('telefone')||'' }));
  } else {
    store.clientes = JSON.parse(localStorage.getItem('clientes')||'[]');
  }
  return store.clientes;
}
async function saveCliente(c){
  // c = { id?, nome, telefone }  -- telefone j√° padronizado com preparePhoneForSave()
  if (USING_PARSE){
    const C = Parse.Object.extend('Cliente');
    if (c.id){
      const q = new Parse.Query(C); const obj = await q.get(c.id);
      obj.set('nome', c.nome); obj.set('telefone', c.telefone||''); await obj.save();
    } else {
      const obj = new C(); obj.set('nome', c.nome); obj.set('telefone', c.telefone||''); const s = await obj.save(); c.id = s.id;
    }
    await fetchClientes();
  } else {
    if (!c.id) c.id = uid('cli');
    const idx = (store.clientes||[]).findIndex(x=>x.id===c.id);
    if (idx>=0) store.clientes[idx] = c; else store.clientes.push(c);
    localStorage.setItem('clientes', JSON.stringify(store.clientes));
  }
  showToast('Cliente salvo ‚úÖ');
}
async function deleteCliente(id){
  if (USING_PARSE){
    const C = Parse.Object.extend('Cliente'); const q=new Parse.Query(C); const obj=await q.get(id); await obj.destroy(); await fetchClientes();
  } else {
    store.clientes = store.clientes.filter(c=>c.id!==id); localStorage.setItem('clientes', JSON.stringify(store.clientes));
  }
  showToast('Cliente removido');
}

/* Produtos */
async function fetchProdutos(){
  if (USING_PARSE){
    const P = Parse.Object.extend('Produto'); const q=new Parse.Query(P); q.ascending('nome');
    const res = await q.find();
    store.produtos = res.map(r=>({ id:r.id, nome:r.get('nome'), descricao:r.get('descricao')||'', preco: r.get('preco')||0 }));
  } else {
    store.produtos = JSON.parse(localStorage.getItem('produtos')||'[]');
  }
  return store.produtos;
}
async function saveProduto(p){
  if (USING_PARSE){
    const P = Parse.Object.extend('Produto');
    if (p.id){
      const q=new Parse.Query(P); const obj=await q.get(p.id);
      obj.set('nome', p.nome); obj.set('descricao', p.descricao||''); obj.set('preco', p.preco||0); await obj.save();
    } else {
      const obj = new P(); obj.set('nome', p.nome); obj.set('descricao', p.descricao||''); obj.set('preco', p.preco||0); const s = await obj.save(); p.id = s.id;
    }
    await fetchProdutos();
  } else {
    if (!p.id) p.id = uid('prd');
    const idx = (store.produtos||[]).findIndex(x=>x.id===p.id);
    if (idx>=0) store.produtos[idx] = p; else store.produtos.push(p);
    localStorage.setItem('produtos', JSON.stringify(store.produtos));
  }
  showToast('Produto salvo ‚úÖ');
}
async function deleteProduto(id){
  if (USING_PARSE){
    const P = Parse.Object.extend('Produto'); const q=new Parse.Query(P); const obj=await q.get(id); await obj.destroy(); await fetchProdutos();
  } else {
    store.produtos = store.produtos.filter(p=>p.id!==id); localStorage.setItem('produtos', JSON.stringify(store.produtos));
  }
  showToast('Produto removido');
}

/* Encomendas */
async function fetchEncomendas(){
  if (USING_PARSE){
    const En = Parse.Object.extend('Encomenda'); const q=new Parse.Query(En); q.descending('createdAt'); q.include('cliente'); q.include('produto');
    const res = await q.find();
    store.encomendas = res.map(r=>({
      id: r.id,
      clienteId: r.get('cliente') ? r.get('cliente').id : null,
      clienteNome: r.get('cliente') ? r.get('cliente').get('nome') : r.get('clienteNome') || '',
      produtoId: r.get('produto') ? r.get('produto').id : null,
      produtoNome: r.get('produto') ? r.get('produto').get('nome') : r.get('produtoNome') || '',
      quantidade: r.get('quantidade') || 1,
      valor: r.get('valor') || 0,
      dataEntrega: r.get('dataEntrega') || '',
      statusProducao: r.get('statusProducao') || 'A Fazer',
      statusPagamento: r.get('statusPagamento') || 'Pendente',
      logs: r.get('logs') || []
    }));
  } else {
    store.encomendas = JSON.parse(localStorage.getItem('encomendas')||'[]');
  }
  return store.encomendas;
}
async function saveEncomenda(en){
  /* en = { id?, clienteId, clienteNome, produtoId, produtoNome, quantidade, valor, dataEntrega (string), statusProducao, statusPagamento, logs } */
  if (USING_PARSE){
    const En = Parse.Object.extend('Encomenda');
    if (en.id){
      const q = new Parse.Query(En); const obj = await q.get(en.id);
      if (en.clienteId) obj.set('cliente', { __type:'Pointer', className:'Cliente', objectId: en.clienteId }); else obj.set('clienteNome', en.clienteNome);
      if (en.produtoId) obj.set('produto', { __type:'Pointer', className:'Produto', objectId: en.produtoId }); else obj.set('produtoNome', en.produtoNome);
      obj.set('quantidade', en.quantidade || 1); obj.set('valor', en.valor || 0);
      obj.set('dataEntrega', en.dataEntrega || '');
      obj.set('statusProducao', en.statusProducao || 'A Fazer'); obj.set('statusPagamento', en.statusPagamento || 'Pendente'); obj.set('logs', en.logs || []);
      await obj.save();
    } else {
      const obj = new En();
      if (en.clienteId) obj.set('cliente', { __type:'Pointer', className:'Cliente', objectId: en.clienteId }); else obj.set('clienteNome', en.clienteNome);
      if (en.produtoId) obj.set('produto', { __type:'Pointer', className:'Produto', objectId: en.produtoId }); else obj.set('produtoNome', en.produtoNome);
      obj.set('quantidade', en.quantidade || 1); obj.set('valor', en.valor || 0);
      obj.set('dataEntrega', en.dataEntrega || '');
      obj.set('statusProducao', en.statusProducao || 'A Fazer'); obj.set('statusPagamento', en.statusPagamento || 'Pendente'); obj.set('logs', en.logs || []);
      const s = await obj.save(); en.id = s.id;
    }
    await fetchEncomendas();
  } else {
    if (!en.id) en.id = uid('enc');
    const idx = (store.encomendas||[]).findIndex(x=>x.id===en.id);
    if (idx>=0) store.encomendas[idx] = en; else store.encomendas.unshift(en);
    localStorage.setItem('encomendas', JSON.stringify(store.encomendas));
  }
  showToast('Encomenda salva ‚úÖ');
}
async function deleteEncomenda(id){
  if (USING_PARSE){
    const En = Parse.Object.extend('Encomenda'); const q=new Parse.Query(En); const obj = await q.get(id); await obj.destroy(); await fetchEncomendas();
  } else {
    store.encomendas = store.encomendas.filter(e=>e.id!==id); localStorage.setItem('encomendas', JSON.stringify(store.encomendas));
  }
  showToast('Encomenda cancelada');
}

/* =================== UTILS =================== */

/**
 * Prepara e valida o telefone informado:
 * aceita entradas como "(21) 98765-4321", "21987654321", "987654321", "+5521987654321"
 * Retorna telefone padronizado: "+55DDDN√öMERO" ou null se inv√°lido.
 */
function preparePhoneForSave(raw){
  if (!raw) return null;
  let s = String(raw).trim();
  // remove tudo que nao digito ou +
  s = s.replace(/[^\d+]/g, '');
  // se come√ßar com +, remove o +
  if (s.startsWith('+')) s = s.slice(1);
  // se come√ßou com 0 em excesso (tipo 0XXXXXXXX) remove leading zeros
  s = s.replace(/^0+/, '');
  // agora s deve ser s√≥ d√≠gitos. Se j√° tiver country code 55
  if (s.startsWith('55')) {
    s = s.slice(2);
  }
  // se tiver 11 d√≠gitos -> DDD + 9 digitos (celular)
  // se tiver 10 d√≠gitos -> DDD + 8 digitos (fixo)
  // se tiver 9 ou 8 -> sem DDD -> n√£o aceitamos, pede DDD
  if (s.length === 11 || s.length === 10){
    return '+55' + s;
  }
  // se tiver 9 e o usu√°rio esqueceu o DDD, n√£o aceitamos (pede DDD)
  return null;
}

/* calcula valor da encomenda com base no produto e quantidade */
function calcularValorEncomenda(produtoId, quantidade){
  const p = store.produtos.find(x=>x.id===produtoId) || { preco:0 };
  return (parseFloat(p.preco)||0) * (parseFloat(quantidade)||0);
}

/* cria mensagem padronizada para WhatsApp */
function montarMensagemWhatsApp(en){
  const nome = en.clienteNome || '';
  const produto = en.produtoNome || '';
  const data = en.dataEntrega || '';
  // garantir dd/mm/yyyy se for ISO
  let displayDate = data;
  // se data for ISO yyyy-mm-dd ou Date object string
  if (/^\d{4}-\d{2}-\d{2}$/.test(data)){
    const parts = data.split('-');
    displayDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
  }
  return `Ol√°, ${nome}! Sua encomenda do produto ${produto} est√° prevista para ${displayDate}.`;
}

/* =================== RENDERIZA√á√ÉO =================== */

async function renderAll(){
  await fetchClientes(); await fetchProdutos(); await fetchEncomendas();
  document.getElementById('kpi-faturamento').textContent = money(store.encomendas.filter(e=>e.statusProducao==='Entregue').reduce((s,e)=>s+ (e.valor||0),0));
  document.getElementById('kpi-encomendas').textContent = store.encomendas.filter(e=>e.statusProducao!=='Entregue').length;
  document.getElementById('dashboard-date').textContent = new Date().toLocaleDateString();
  renderClientes(); renderProdutos(); renderEncomendas(); renderDashboardLatest();
}

function renderDashboardLatest(){
  const latest = (store.encomendas||[]).slice(0,5);
  const container = document.getElementById('dashboard-latest');
  if (!latest.length) container.innerHTML = '<p class="muted">Nenhuma encomenda ainda.</p>';
  else container.innerHTML = latest.map(e=>`
    <div class="list-item">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <div><strong>${e.clienteNome || 'Cliente'}</strong><div class="muted small">${(e.dataEntrega)}</div></div>
        <div>${money(e.valor)}</div>
      </div>
      <div class="muted small">${e.quantidade} x ${e.produtoNome} ‚Ä¢ ${e.statusProducao}</div>
    </div>
  `).join('');
}

function renderProdutos(){
  const c = document.getElementById('produtos-list');
  if (!store.produtos.length) { c.innerHTML = '<p class="muted">Nenhum produto. <button class="btn" id="addFirstProduto">Adicionar</button></p>'; setTimeout(()=>document.getElementById('addFirstProduto')?.addEventListener('click', openProdutoModal),50); return; }
  c.innerHTML = store.produtos.map(p=>`
    <div class="card" style="display:flex; justify-content:space-between; align-items:center">
      <div>
        <h4>${p.nome}</h4>
        <div class="muted small">${p.descricao||''}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">${money(p.preco)}</div>
        <div style="margin-top:0.5rem">
          <button class="btn" onclick="editarProduto('${p.id}')">‚úèÔ∏è</button>
          <button class="btn secondary" onclick="removerProduto('${p.id}')">üóëÔ∏è</button>
        </div>
      </div>
    </div>
  `).join('');
}

function renderClientes(){
  const c = document.getElementById('clientes-list');
  if (!store.clientes.length) { c.innerHTML = '<p class="muted">Nenhum cliente. <button class="btn" id="addFirstCliente">Adicionar</button></p>'; setTimeout(()=>document.getElementById('addFirstCliente')?.addEventListener('click', openClienteModal),50); return; }
  c.innerHTML = store.clientes.map(cl=>`
    <div class="card" style="display:flex; justify-content:space-between; align-items:center">
      <div><strong>${cl.nome}</strong><div class="muted small">${cl.telefone||''}</div></div>
      <div>
        <button class="btn" onclick="editarCliente('${cl.id}')">‚úèÔ∏è</button>
        <button class="btn secondary" onclick="removerCliente('${cl.id}')">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
}

function renderEncomendas(){
  const c = document.getElementById('encomendas-list');
  if (!store.encomendas.length) { c.innerHTML = '<p class="muted">Nenhuma encomenda. <button class="btn" id="addFirstEncomenda">Criar</button></p>'; setTimeout(()=>document.getElementById('addFirstEncomenda')?.addEventListener('click', ()=>openEncomendaModal()),50); return; }
  c.innerHTML = store.encomendas.map(e=>`
    <div class="card">
      <div style="display:flex; gap:1rem; align-items:center">
        <div style="flex:1">
          <strong>${e.clienteNome || 'Cliente'}</strong>
          <div class="muted small">${(e.dataEntrega)}</div>
          <div style="margin-top:0.5rem">${e.produtoNome} ‚Ä¢ ${e.quantidade} unidades</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700">${money(e.valor)}</div>
          <div class="muted small">Status: ${e.statusProducao}</div>
          <div style="margin-top:0.6rem">
            <button class="btn" onclick="editarEncomenda('${e.id}')">‚úèÔ∏è</button>
            <button class="btn" onclick="abrirStatusModal('${e.id}')">‚öôÔ∏è</button>
            <button class="btn secondary" onclick="compartilharWhatsApp('${e.id}')">üì≤ WhatsApp</button>
            <button class="btn secondary" onclick="cancelarEncomenda('${e.id}')">üóëÔ∏è</button>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

/* =================== MODAIS & CRUD UI =================== */
const modalRoot = document.getElementById('modalRoot');
function openModal(html){ modalRoot.style.display='block'; modalRoot.innerHTML = `<div class="modal">${html}</div>`; }
function closeModal(){ modalRoot.style.display='none'; modalRoot.innerHTML=''; }

/* CLIENTE */
function openClienteModal(existing){
  const nome = existing?.nome || '';
  const tel = existing?.telefone || '';
  openModal(`
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center"><h3>${existing?'Editar Cliente':'Novo Cliente'}</h3><div class="close-x" onclick="closeModal()">‚úñ</div></div>
      <label>Nome<input id="m_cli_nome" placeholder="Ex: Maria da Silva" value="${nome}"></label>
      <label>Telefone<input id="m_cli_tel" placeholder="Ex: (21) 98765-4321 ‚Äî ser√° salvo como +5521987654321" value="${tel}"></label>
      <div class="hint">Formato salvo para WhatsApp: +55DDDN√öMERO (ser√° formatado automaticamente)</div>
      <div style="display:flex; gap:0.5rem; margin-top:1rem">
        <button class="btn" id="saveCliBtn">Salvar</button>
        <button class="btn secondary" onclick="closeModal()">Cancelar</button>
      </div>
    </div>
  `);
  document.getElementById('saveCliBtn').addEventListener('click', async ()=>{
    const nomeVal = document.getElementById('m_cli_nome').value.trim();
    const telRaw = document.getElementById('m_cli_tel').value.trim();
    if (!nomeVal) return showToast('Nome √© obrigat√≥rio');
    const telPrepared = preparePhoneForSave(telRaw);
    if (!telPrepared) return alert('Telefone inv√°lido. Inclua DDD (ex: (21) 98765-4321).');
    const c = { id: existing?.id, nome: nomeVal, telefone: telPrepared };
    await saveCliente(c); await renderAll(); closeModal();
  });
}
window.openClienteModal = openClienteModal;
function editarCliente(id){ const c = store.clientes.find(x=>x.id===id); if(!c) return; openClienteModal(c); }
function removerCliente(id){ if(!confirm('Remover cliente?')) return; deleteCliente(id).then(()=>renderAll()); }

/* PRODUTO */
function openProdutoModal(existing){
  const nome = existing?.nome || '';
  const desc = existing?.descricao || '';
  const preco = existing?.preco || '';
  openModal(`
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center"><h3>${existing?'Editar Produto':'Novo Produto'}</h3><div class="close-x" onclick="closeModal()">‚úñ</div></div>
      <label>Nome<input id="m_prd_nome" placeholder="Ex: Brigadeiro Gourmet" value="${nome}"></label>
      <label>Pre√ßo (ex: 40 ‚Äî sem v√≠rgula; pode usar decimais com ponto: 40.50)<input id="m_prd_preco" type="text" placeholder="Ex: 40" value="${preco}"></label>
      <label>Descri√ß√£o<textarea id="m_prd_desc" placeholder="Breve descri√ß√£o">${desc}</textarea></label>
      <div style="display:flex; gap:0.5rem; margin-top:1rem">
        <button class="btn" id="savePrdBtn">Salvar</button>
        <button class="btn secondary" onclick="closeModal()">Cancelar</button>
      </div>
    </div>
  `);
  document.getElementById('savePrdBtn').addEventListener('click', async ()=>{
    const nomeVal = document.getElementById('m_prd_nome').value.trim();
    let precoRaw = document.getElementById('m_prd_preco').value.trim();
    const descVal = document.getElementById('m_prd_desc').value.trim();
    if (!nomeVal) return showToast('Nome √© obrigat√≥rio');
    // normalizar preco: aceita "40" ou "40.50" ou "40,50"
    precoRaw = precoRaw.replace(',', '.');
    const precoNum = parseFloat(precoRaw) || 0;
    const p = { id: existing?.id, nome: nomeVal, preco: precoNum, descricao: descVal };
    await saveProduto(p); await renderAll(); closeModal();
  });
}
window.openProdutoModal = openProdutoModal;
function editarProduto(id){ const p = store.produtos.find(x=>x.id===id); if(!p) return; openProdutoModal(p); }
function removerProduto(id){ if(!confirm('Remover produto?')) return; deleteProduto(id).then(()=>renderAll()); }

/* ENCOMENDA */
function openEncomendaModal(existing){
  const clientesOptions = ['<option value="">Selecione...</option>'].concat(store.clientes.map(c=>`<option value="${c.id}">${c.nome}</option>`)).join('');
  const produtosOptions = ['<option value="">Selecione...</option>'].concat(store.produtos.map(p=>`<option value="${p.id}" data-preco="${p.preco}">${p.nome} - ${p.preco}</option>`)).join('');
  const dataVal = existing?.dataEntrega ? existing.dataEntrega : new Date().toISOString().slice(0,10);
  const quantidadeVal = existing?.quantidade || 1;
  const valorVal = existing?.valor || '';
  openModal(`
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center"><h3>${existing?'Editar Encomenda':'Nova Encomenda'}</h3><div class="close-x" onclick="closeModal()">‚úñ</div></div>
      <label>Cliente<select id="m_enc_cliente">${clientesOptions}</select></label>
      <label>Produto<select id="m_enc_produto">${produtosOptions}</select></label>
      <label>Quantidade<input id="m_enc_qtd" type="number" min="1" value="${quantidadeVal}"></label>
      <label>Valor (ex: 40 ‚Äî sem v√≠rgula; use ponto para decimais: 40.50)<input id="m_enc_valor" type="text" placeholder="Ex: 40" value="${valorVal}"></label>
      <label>Data de entrega<input id="m_enc_data" type="date" value="${dataVal}"></label>
      <div style="display:flex; gap:0.5rem; margin-top:1rem">
        <button class="btn" id="saveEncBtn">Salvar</button>
        <button class="btn secondary" onclick="closeModal()">Cancelar</button>
      </div>
    </div>
  `);

  // se editar, preenche selects
  if (existing){
    document.getElementById('m_enc_cliente').value = existing.clienteId || '';
    document.getElementById('m_enc_produto').value = existing.produtoId || '';
    document.getElementById('m_enc_qtd').value = existing.quantidade || 1;
    document.getElementById('m_enc_valor').value = existing.valor || '';
  }

  document.getElementById('saveEncBtn').addEventListener('click', async ()=>{
    const clienteId = document.getElementById('m_enc_cliente').value;
    const produtoId = document.getElementById('m_enc_produto').value;
    const quantidade = parseInt(document.getElementById('m_enc_qtd').value) || 1;
    let valorRaw = document.getElementById('m_enc_valor').value.trim();
    const dataEntrega = document.getElementById('m_enc_data').value;
    if (!clienteId || !produtoId) return showToast('Selecione cliente e produto');
    // normalizar valor
    valorRaw = valorRaw.replace(',', '.');
    const valor = parseFloat(valorRaw) || calcularValorEncomenda(produtoId, quantidade);
    const clienteNome = (store.clientes.find(c=>c.id===clienteId)||{}).nome || '';
    const produtoNome = (store.produtos.find(p=>p.id===produtoId)||{}).nome || '';
    const en = { id: existing?.id, clienteId, clienteNome, produtoId, produtoNome, quantidade, valor, dataEntrega, statusProducao: existing?.statusProducao || 'A Fazer', statusPagamento: existing?.statusPagamento || 'Pendente', logs: existing?.logs||[] };
    pushLog(en, existing ? 'Encomenda editada' : 'Encomenda criada');
    await saveEncomenda(en);
    await renderAll();
    closeModal();

    // Depois de salvo: mostrar bot√£o r√°pido para abrir WhatsApp j√° com a mensagem
    setTimeout(()=> {
      const mensagem = montarMensagemWhatsApp(en);
      const cliente = store.clientes.find(c=>c.id===en.clienteId) || { telefone:'' };
      const numero = (cliente.telefone || '');
      if (!numero){
        alert('Encomenda salva, mas cliente n√£o tem telefone v√°lido para WhatsApp.');
        return;
      }
      // mostrar modal simples com bot√£o
      openModal(`
        <div class="modal-card">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <h3>Encomenda salva ‚úÖ</h3>
            <div class="close-x" onclick="closeModal()">‚úñ</div>
          </div>
          <p>Mensagem pronta para enviar via WhatsApp:</p>
          <div class="card"><em>${mensagem}</em></div>
          <div style="display:flex; gap:0.6rem; margin-top:1rem">
            <button class="btn" id="openWppBtn">Abrir WhatsApp</button>
            <button class="btn secondary" onclick="closeModal()">Fechar</button>
          </div>
        </div>
      `);
      document.getElementById('openWppBtn').addEventListener('click', ()=>{
        // wa.me precisa do n√∫mero sem + e sem espa√ßo
        const n = numero.replace(/\D/g,'');
        const url = `https://wa.me/${n}?text=${encodeURIComponent(mensagem)}`;
        window.open(url, '_blank');
      });
    }, 200);
  });
}
window.openEncomendaModal = openEncomendaModal;
function editarEncomenda(id){ const e = store.encomendas.find(x=>x.id===id); if(!e) return; openEncomendaModal(e); }
function cancelarEncomenda(id){ if(!confirm('Cancelar encomenda?')) return; deleteEncomenda(id).then(()=>renderAll()); }

/* STATUS modal */
function abrirStatusModal(id){
  const e = store.encomendas.find(x=>x.id===id); if(!e) return;
  openModal(`
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center"><h3>Atualizar Status - ${e.clienteNome}</h3><div class="close-x" onclick="closeModal()">‚úñ</div></div>
      <label>Status Produ√ß√£o
        <select id="m_st_prod">
          <option value="A Fazer">A Fazer</option>
          <option value="Pronto para Entrega">Pronto para Entrega</option>
          <option value="Entregue">Entregue</option>
        </select>
      </label>
      <label>Status Pagamento
        <select id="m_st_pay">
          <option value="Pendente">Pendente</option>
          <option value="Sinal Pago">Sinal Pago</option>
          <option value="Pago Totalmente">Pago Totalmente</option>
        </select>
      </label>
      <div style="display:flex; gap:0.5rem; margin-top:1rem">
        <button class="btn" id="saveStatusBtn">Salvar</button>
        <button class="btn secondary" onclick="closeModal()">Cancelar</button>
      </div>
    </div>
  `);
  document.getElementById('m_st_prod').value = e.statusProducao || 'A Fazer';
  document.getElementById('m_st_pay').value = e.statusPagamento || 'Pendente';
  document.getElementById('saveStatusBtn').addEventListener('click', async ()=>{
    const novoProd = document.getElementById('m_st_prod').value;
    const novoPay = document.getElementById('m_st_pay').value;
    e.statusProducao = novoProd; e.statusPagamento = novoPay;
    pushLog(e, `Status produ√ß√£o: ${novoProd} | pagamento: ${novoPay}`);
    await saveEncomenda(e); await renderAll(); closeModal();
  });
}

/* WhatsApp direta da lista */
function compartilharWhatsApp(id){
  const e = store.encomendas.find(x=>x.id===id); if(!e) return;
  const cliente = store.clientes.find(c=>c.id===e.clienteId) || { telefone:'' };
  const numero = (cliente.telefone||'');
  if (!numero) { alert('Telefone inv√°lido para WhatsApp'); return; }
  const mensagem = montarMensagemWhatsApp(e);
  const n = numero.replace(/\D/g,'');
  const url = `https://wa.me/${n}?text=${encodeURIComponent(mensagem)}`;
  window.open(url, '_blank');
}

/* =================== HELPERS =================== */
function pushLog(en, text){
  en.logs = en.logs || []; en.logs.push(`${new Date().toLocaleString()} - ${text}`);
}

/* =================== NAV & INIT =================== */
function showView(hash){
  document.querySelectorAll('.view').forEach(v=>v.style.display='none');
  const h = hash || '#dashboard';
  const map = { '#dashboard':'view-dashboard', '#produtos':'view-produtos', '#encomendas':'view-encomendas', '#clientes':'view-clientes' };
  const key = map[h] || 'view-dashboard';
  document.getElementById(key).style.display='block';
  document.querySelectorAll('.nav-btn').forEach(b=> b.classList.toggle('active', b.dataset.hash===h));
  const btn = document.getElementById('btnNovo');
  btn.onclick = null;
  if (h==='#produtos'){ btn.textContent = '+ Produto'; btn.onclick = ()=>openProdutoModal(); }
  else if (h==='#clientes'){ btn.textContent = '+ Cliente'; btn.onclick = ()=>openClienteModal(); }
  else if (h==='#encomendas'){ btn.textContent = '+ Encomenda'; btn.onclick = ()=>openEncomendaModal(); }
  else { btn.textContent = '+ Novo'; btn.onclick = ()=>openEncomendaModal(); }
}

window.addEventListener('hashchange', ()=> showView(location.hash));
document.querySelectorAll('.nav-btn').forEach(b=> b.addEventListener('click', ()=> location.hash = b.dataset.hash ));
document.getElementById('btnNovoProduto').addEventListener('click', ()=> openProdutoModal());
document.getElementById('btnNovoCliente').addEventListener('click', ()=> openClienteModal());
document.getElementById('btnNovaEncomenda').addEventListener('click', ()=> openEncomendaModal());

window.editarProduto = editarProduto; window.removerProduto = removerProduto;
window.editarCliente = editarCliente; window.removerCliente = removerCliente;
window.editarEncomenda = editarEncomenda; window.cancelarEncomenda = cancelarEncomenda;

/* inicializa */
(async function init(){
  await renderAll();
  showView(location.hash || '#dashboard');
})();
</script>
</body>
</html>

